<!doctype html>
<html lang="en" data-theme="dark">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>MEDI2101B Timetable</title>
<style>
  :root{
    --bg-dark:#0b0c10; --card-dark:#111318; --elev-dark:#151824; --text-dark:#e5e7eb; --muted-dark:#9aa1ac; --border-dark:#23273a; --chip-dark:#1a1e2a;
    --bg-light:#f6f7fb; --card-light:#ffffff; --elev-light:#f9fafc; --text-light:#0b1220; --muted-light:#5d6470; --border-light:#e1e5ef; --chip-light:#eef2f7;

    --anatomy:#3b82f6; --pbl:#10b981; --clinical:#f59e0b; --physiology:#06b6d4; --info:#a78bfa; --lecture:#eab308; --default:#94a3b8;
    --accent:#3aa0ff; --good:#22c55e; --warn:#f59e0b; --bad:#ef4444;
  }
  html[data-theme="dark"]{ --bg:var(--bg-dark); --card:var(--card-dark); --elev:var(--elev-dark); --text:var(--text-dark); --muted:var(--muted-dark); --border:var(--border-dark); --chip:var(--chip-dark); color-scheme:dark; }
  html[data-theme="light"]{ --bg:var(--bg-light); --card:var(--card-light); --elev:var(--elev-light); --text:var(--text-light); --muted:var(--muted-light); --border:var(--border-light); --chip:var(--chip-light); color-scheme:light; }

  *{ box-sizing:border-box }
  html, body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Inter, Roboto, Arial; background:var(--bg); color:var(--text); }
  a{ color:inherit; text-decoration: none; }
  .app { display:grid; grid-template-columns: 260px 1fr 340px; gap:12px; max-width:1400px; margin:0 auto; padding:14px; }
  @media (max-width:1100px){ .app{ grid-template-columns: 220px 1fr; } .aside{ display:none; } }
  @media (max-width:720px){ .app{ grid-template-columns: 1fr; } .sidebar{ order:2 } }

  .sidebar{ background:var(--card); border:1px solid var(--border); border-radius:16px; padding:12px; position:sticky; top:14px; height:max-content; }
  .aside{ background:var(--card); border:1px solid var(--border); border-radius:16px; padding:12px; position:sticky; top:14px; height:max-content; }
  .main{ min-height:60vh; }

  .hstack{ display:flex; align-items:center; gap:8px; }
  .space{ flex:1 }
  .title{ font-weight:800; font-size:18px }
  .muted{ color:var(--muted); font-size:12px }
  .chip{ display:inline-flex; align-items:center; gap:6px; background:var(--chip); border:1px solid var(--border); border-radius:999px; padding:6px 10px; font-size:12px; color:var(--muted) }
  .btn{ background:var(--elev); border:1px solid var(--border); color:var(--text); padding:8px 12px; border-radius:10px; cursor:pointer; }
  .btn:hover{ filter:brightness(1.07) }
  .btn.ghost{ background:transparent }
  .select, select, input[type=text], input[type=number]{ width:100%; background:var(--elev); color:var(--text); border:1px solid var(--border); border-radius:10px; padding:10px 12px; appearance:none; -webkit-appearance:none; -moz-appearance:none; }
  select:focus, input:focus{ outline:2px solid var(--accent) }

  .tabs{ display:flex; gap:8px; border-bottom:1px solid var(--border); margin-bottom:8px; }
  .tab{ padding:10px 12px; border-radius:10px 10px 0 0; cursor:pointer; color:var(--muted) }
  .tab.active{ color:var(--text); background:var(--card); border:1px solid var(--border); border-bottom-color:transparent }

  .card{ background:var(--card); border:1px solid var(--border); border-radius:14px; padding:12px; box-shadow:0 6px 20px rgba(0,0,0,.06); }
  .grid{ display:grid; grid-template-columns: minmax(0,1fr); gap:10px }
  .date-header{ grid-column:span 12; padding:6px 2px; font-weight:800; font-size:13px; color:var(--muted); border-bottom:1px solid var(--border) }

  .event{ display:grid; grid-template-columns:8px 120px 1fr 0.9fr; gap:10px; align-items:center; padding:10px; background:var(--elev); border:1px solid var(--border); border-radius:10px }
  .event .where{ display:flex; flex-wrap:wrap; gap:8px; justify-content:center }
  .event.compact{ grid-template-columns:8px 120px 1fr }
  .bar{ width:8px; height:100%; border-radius:6px; background:var(--default) }
  .when{ font-variant-numeric:tabular-nums; font-weight:700 }
  .sub{ color:var(--muted); font-size:12px }
  .live{ outline:2px solid var(--good) }
  .soon{ outline:none; box-shadow:none } /* no amber cue */

  .banner{ display:flex; align-items:center; gap:8px; padding:10px 12px; border:1px solid var(--border); border-radius:12px; }
  .banner.live{ background:rgba(34,197,94,.12) }
  .banner.next{ background:rgba(58,160,255,.12) }

  .legend{ display:flex; gap:6px; flex-wrap:wrap }
  .legend .swatch{ width:10px; height:10px; border-radius:2px; display:inline-block; margin-right:4px }

  .smiley{ font-size:40px; line-height:1 }

  /* Sidebar rhythm */
  .sidebar .muted#nowstr{ margin-top:4px; margin-bottom:6px }
  .sidebar #weather-card{ margin-top:12px; margin-bottom:12px }
  .sidebar .sub{ margin-top:12px; margin-bottom:4px }
  .sidebar .legend{ margin-top:8px }
  .sidebar .hstack + .hstack{ margin-top:8px }

  /* Weather card */
  .weather.card{ background:var(--elev); display:flex; align-items:center; gap:10px; }
  .weather-emoji{ font-size:24px; line-height:1 }
  .weather-temp{ font-weight:800; font-size:18px }

  /* Toast */
  .toast{ position:fixed; left:50%; bottom:16px; transform:translateX(-50%); background:var(--card); border:1px solid var(--border); padding:10px 14px; border-radius:10px; box-shadow:0 8px 20px rgba(0,0,0,.15); z-index:1000; opacity:0; transition:opacity .2s, transform .2s; }
  .toast.show{ opacity:1; transform:translateX(-50%) translateY(-6px); }
  @keyframes pulse-scale{ 0%{ transform:scale(1) } 50%{ transform:scale(1.08) } 100%{ transform:scale(1) } }
  .pulse{ animation: pulse-scale .35s ease-in-out; }

  /* Center Today view */
  #today, #today-content, #countdown{ max-width: 960px; margin-left:auto; margin-right:auto; }
  #today > *, #today-content > *{ max-width: 960px; margin-left:auto; margin-right:auto; }
</style>

</head>
<body>
<div class="app">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="hstack">
      <div class="title">MEDI2101B</div>
      <div class="space"></div>
      <button id="btn-theme" class="btn" title="Light/Dark">üåì</button>
    </div>
    <div class="muted" id="nowstr"></div>
    <div class="weather card" id="weather-card">
      <div id="weather-emoji" class="weather-emoji">üå°Ô∏è</div>
      <div>
        <div id="weather-temp" class="weather-temp">‚Äî</div>
        <div class="sub"><span id="weather-hilo">H ‚Äî / L ‚Äî</span> ¬∑ Rain <span id="weather-rain">‚Äî</span>%</div>
      </div>
    </div>

    <div class="sub">Campus</div>
    <select id="sel-campus"><option>Both</option><option>Callaghan</option><option>CCS</option></select>
    <div class="sub">PBL Group</div>
    <select id="sel-group"><option>ALL</option><option>A</option><option>B</option><option>C</option><option>D</option><option>E</option><option>F</option><option>G</option><option>H</option><option>I</option><option>J</option><option>K</option><option>L</option><option>M</option><option>N</option><option>O</option><option>P</option></select>
    <div class="sub">Domain</div>
    <select id="sel-domain"><option value="ALL">ALL</option></select>

    <div class="legend sub">
      <span><span class="swatch" style="background:#3b82f6"></span> Anatomy</span>
      <span><span class="swatch" style="background:#10b981"></span> PBL</span>
      <span><span class="swatch" style="background:#f59e0b"></span> Clinical</span>
      <span><span class="swatch" style="background:#eab308"></span> Lecture</span>
    </div>

    <div class="hstack">
      <button id="btn-compact" class="btn">Compact</button>
      <button id="btn-ics" class="btn">Export ICS</button>
    </div>
    <div class="hstack">
      <button id="btn-load" class="btn">Load Data</button>
      <button id="btn-settings" class="btn">Settings</button>
    </div>
    <div class="sub" id="filterstr"></div>
  </aside>

  <!-- Main -->
  <main class="main">
    <div class="tabs">
      <div class="tab active" data-tab="today">Today</div>
      <div class="tab" data-tab="week">Week</div>
      <div class="tab" data-tab="all">All</div>
      <div class="space"></div>
      <button id="btn-bell" class="btn ghost" title="Notify 10 min before next event">üîî</button>
    </div>

    <div id="today" class="grid" style="gap:12px; align-content:start">
      <div class="card banner" id="countdown"></div>
      <div id="today-content" class="grid"></div>
    </div>

    <div id="week" class="grid" style="display:none">
      <div class="card">
        <div class="hstack">
          <button class="btn" id="btn-prev-week">‚óÄ</button>
          <div class="space"></div>
          <div class="sub" id="week-label"></div>
          <div class="space"></div>
          <button class="btn" id="btn-next-week">‚ñ∂</button>
        </div>
        <div class="grid" id="week-grid" style="margin-top:8px"></div>
      </div>
    </div>

    <div id="all" class="grid" style="display:none"></div>
  </main>

  <!-- Right Summary (only when sessions today) -->
  <aside class="aside" id="aside"></aside>
</div>
<div id="toast" class="toast" role="status" aria-live="polite" style="display:none"></div>

<!-- Settings modal -->
<div class="modal-backdrop" id="modal-backdrop" aria-hidden="true" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.6);z-index:999;">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title" style="width:min(680px,94vw);background:var(--card);border:1px solid var(--border);border-radius:16px;padding:18px;position:relative;">
    <button class="x" id="btn-x" title="Close" style="position:absolute;right:10px;top:10px;width:28px;height:28px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--text);cursor:pointer;">‚úï</button>
    <div style="font-size:18px;font-weight:800;margin-bottom:6px" id="modal-title">Setup</div>
    <div class="sub" style="margin-bottom:10px">Campus, PBL, name, transit, buffers.</div>
    <div class="grid">
      <div style="grid-column:span 6">
        <div class="sub">Campus</div>
        <select id="set-campus"><option>Both</option><option>Callaghan</option><option>CCS</option></select>
      </div>
      <div style="grid-column:span 6">
        <div class="sub">PBL Group</div>
        <select id="set-group"><option>ALL</option><option>A</option><option>B</option><option>C</option><option>D</option><option>E</option><option>F</option><option>G</option><option>H</option><option>I</option><option>J</option><option>K</option><option>L</option><option>M</option><option>N</option><option>O</option><option>P</option></select>
      </div>
      <div style="grid-column:span 12">
        <div class="sub">Optional label</div>
        <input id="set-label" placeholder="e.g., Callaghan ‚Äì Group H">
      </div>
      <div style="grid-column:span 12">
        <div class="sub">Your name (optional)</div>
        <input id="set-name" placeholder="e.g., Noofie">
      </div>
      <div style="grid-column:span 12">
        <div class="sub">Time format</div>
        <select id="set-timefmt"><option value="24h">24h (13:00)</option><option value="12h">12h (1:00 pm)</option></select>
      </div>
      <div style="grid-column:span 6">
        <div class="sub">Home station / address</div>
        <input id="set-home" placeholder="e.g., Hamilton Station">
      </div>
      <div style="grid-column:span 6">
        <div class="sub">Campus station</div>
        <input id="set-campus-st" placeholder="Gosford Station">
      </div>
      <div style="grid-column:span 6">
        <div class="sub">Arrive buffer (min)</div>
        <input id="set-arrive" type="number" min="0" value="15">
      </div>
      <div style="grid-column:span 6">
        <div class="sub">Leave buffer (min)</div>
        <input id="set-leave" type="number" min="0" value="10">
      </div>
    </div>
    <div class="hstack" style="justify-content:flex-end; margin-top:10px">
      <button class="btn" id="btn-save">Save</button>
      <button class="btn" id="btn-close">Close</button>
    </div>
  </div>
</div>

<input type="file" id="file-input" accept=".json,.csv" style="display:none"/>

<script>
  // --- State & prefs ---
  let EVENTS = [];
  let DOMAIN = "ALL";
  let compact = false;
  let weekOffset = 0;

  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const pad = n => String(n).padStart(2,'0');
  const sanitize = s => String(s||'').replace(/[&<>]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));

  function theme(){ return localStorage.getItem('medi_theme') || 'dark'; }
  function setTheme(t){ document.documentElement.setAttribute('data-theme', t==='light'?'light':'dark'); localStorage.setItem('medi_theme', t); }

  function loadPrefs(){ try{ const r=localStorage.getItem('medi2101b_prefs'); return r?JSON.parse(r):null;}catch{ return null; } }
  function defaultPrefs(){ return { campus:'Both', group:'ALL', label:'', name:'', home:'', campusStation:'Gosford Station', arriveBuf:15, leaveBuf:10, timeFmt:'24h' }; }
  function savePrefs(p){ localStorage.setItem('medi2101b_prefs', JSON.stringify(p)); }

  const COLORS = { anatomy:'#3b82f6', pbl:'#10b981', clinical:'#f59e0b', physiology:'#06b6d4', info:'#a78bfa', lecture:'#eab308' };
  function colorFor(ev){
    const d=(ev.domain||'').toLowerCase(), a=(ev.activity||'').toLowerCase();
    if (d in COLORS) return COLORS[d];
    if (a.includes('lecture')) return COLORS.lecture;
    if (d.includes('anatomy')) return COLORS.anatomy;
    if (d.includes('clinical')) return COLORS.clinical;
    if (d.includes('pbl')) return COLORS.pbl;
    if (d.includes('physiology')) return COLORS.physiology;
    if (d.includes('info')) return COLORS.info;
    return 'var(--default)';
  }

  function toDate(s){
    if (s instanceof Date) return s;
    const m = String(s||'').match(/^(\\d{4})-(\\d{2})-(\\d{2})T(\\d{2}):(\\d{2})(?::(\\d{2}))?$/);
    if (m) return new Date(+m[1], +m[2]-1, +m[3], +m[4], +m[5], m[6]?+m[6]:0);
    return new Date(s);
  }
  function fmtHM(d){ return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); }
  function todayKey(d){ return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }
  function byStart(a,b){ return toDate(a.start)-toDate(b.start); }

  function timeFmt(){ const p=Object.assign(defaultPrefs(), loadPrefs()||{}); return p.timeFmt || '24h'; }
  function fmt12(d){
    const h = d.getHours(), m = d.getMinutes();
    const h12 = ((h + 11) % 12) + 1;
    const ampm = h < 12 ? 'am' : 'pm';
    if (m===0) return `${h12} ${ampm}`;
    return `${h12}:${pad(m)} ${ampm}`;
  }
  function fmt24(d){ return `${pad(d.getHours())}:${pad(d.getMinutes())}`; }
  function fmtT(d){
    return timeFmt()==='12h' ? fmt12(d) : fmt24(d);
  }
  function fmtRange(s, e){
    const ss = toDate(s), ee = toDate(e);
    if (timeFmt()==='12h'){
      return `${fmtT(ss)} to ${fmtT(ee)}`;
    }
    return `${fmtT(ss)}-${fmtT(ee)}`;
  }

  function statusFor(ev, now){ const s=toDate(ev.start), e=toDate(ev.end); if(now>=s && now<e) return 'live'; if(now<s){ const mins=Math.floor((s-now)/60000); return mins<=60?'soon':'upcoming'; } return 'past'; }
  function isRemote(ev){ const v=String(ev.venue||''), t=String(ev.title||''), a=String(ev.activity||''); return /zoom|panopto|online|record/i.test(v) || /zoom|online|record/i.test(t) || /online/i.test(a); }
  function normCampus(x){ x=String(x||'').trim().toLowerCase(); if (!x) return 'both'; if (x.includes('/')) return 'both'; if (x==='cal'||x==='callaghan') return 'callaghan'; if (x==='cc'||x==='ccs') return 'ccs'; if (x==='both') return 'both'; return x; }
  function campusMatch(evCampus, prefCampus){ const e=normCampus(evCampus), p=normCampus(prefCampus); if (p==='both' || e==='both') return true; return e===p; }
  function groupMatch(evGroups, prefGroup){ if (prefGroup==='ALL') return true; const gs = Array.isArray(evGroups)? evGroups : String(evGroups||'').split(/[;,\s]+/); return gs.includes(prefGroup) || gs.includes('ALL'); }
  function domainMatch(evDomain){ return DOMAIN==='ALL' || String(evDomain||'').toLowerCase()===DOMAIN.toLowerCase(); }
  function filteredEvents(){
    const prefs = Object.assign(defaultPrefs(), loadPrefs()||{});
    return EVENTS.filter(ev => campusMatch(ev.campus, prefs.campus) && groupMatch(ev.groups, prefs.group) && domainMatch(ev.domain)).sort(byStart);
  }
  function computeNext(evts, now){ return evts.filter(e => toDate(e.end) > now).sort((a,b)=>toDate(a.start)-toDate(b.start))[0] || null; }

  // Weather (Gosford via Open-Meteo)
  async function fetchWeather(){
    const cache = localStorage.getItem('medi_weather_cache');
    if (cache){ try{ const o=JSON.parse(cache); if (Date.now()-o.ts<30*60*1000) return o.data; }catch{} }
    const lat=-33.425, lon=151.341;
    const url=`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&daily=weathercode,temperature_2m_max,temperature_2m_min,precipitation_probability_max&timezone=auto`;
    const r = await fetch(url); const data = await r.json();
    localStorage.setItem('medi_weather_cache', JSON.stringify({ts:Date.now(), data}));
    return data;
  }
  function wmoIcon(c){ const m={0:'‚òÄÔ∏è',1:'üå§Ô∏è',2:'‚õÖ',3:'‚òÅÔ∏è',45:'üå´Ô∏è',48:'üå´Ô∏è',51:'üå¶Ô∏è',53:'üå¶Ô∏è',55:'üå¶Ô∏è',61:'üåßÔ∏è',63:'üåßÔ∏è',65:'üåßÔ∏è',66:'üåßÔ∏è',67:'üåßÔ∏è',71:'üå®Ô∏è',73:'üå®Ô∏è',75:'üå®Ô∏è',80:'üå¶Ô∏è',81:'üåßÔ∏è',82:'üåßÔ∏è',95:'‚õàÔ∏è',96:'‚õàÔ∏è',99:'‚õàÔ∏è'}; return m[c]||'üå°Ô∏è'; }

  function mapsTransitLink(origin, dest, opts={}){
    const base = 'https://www.google.com/maps/dir/?api=1';
    const enc = s => encodeURIComponent(String(s||''));
    const t = opts.time instanceof Date ? Math.round(opts.time.getTime()/1000) : null;
    const when = (opts.type==='arrive' && t) ? `&arrival_time=${t}` : (opts.type==='depart' && t) ? `&departure_time=${t}` : '';
    return `${base}&travelmode=transit&origin=${enc(origin)}&destination=${enc(dest)}&transit_mode=train${when}`;
  }

  function renderEventList(container, list, now){
    const wrapper = document.createElement('div'); wrapper.className='card'; const inner=document.createElement('div');
    list.forEach(ev=>{
      const row=document.createElement('div'); row.className='event ' + statusFor(ev, now) + (compact?' compact':'');
      const bar=document.createElement('div'); bar.className='bar'; bar.style.background=colorFor(ev);
      const when=document.createElement('div'); when.className='when'; const s=toDate(ev.start), e=toDate(ev.end); when.textContent = fmtRange(s, e);
      const main=document.createElement('div'); main.innerHTML = `<div style="font-weight:800">${sanitize(ev.title)}</div><div class="sub">${[ev.domain, ev.activity].filter(Boolean).join(' ¬∑ ')}${ev.staff? ' ¬∑ '+sanitize(ev.staff):''}</div>`;
      const where=document.createElement('div'); 
      let whereHtml = '<span class="chip">'+sanitize(ev.campus||'')+'</span>';
      if (ev.venue) whereHtml += ' <span class="chip">'+sanitize(ev.venue)+'</span>';
      if (ev.staff) whereHtml += ' <span class="chip">'+sanitize(ev.staff)+'</span>';
      where.innerHTML = whereHtml;
      row.append(bar, when, main, where); inner.append(row);
    });
    wrapper.append(inner); container.append(wrapper);
  }

  function renderToday(){
    const now = new Date();
    $('#countdown').innerHTML = '';
    const list = filteredEvents().filter(e=> e.date === todayKey(now));
    const next = computeNext(filteredEvents(), now);
    if (next){
      const st=toDate(next.start), en=toDate(next.end), live= now>=st && now<en, mins = live? Math.max(0,Math.floor((en-now)/60000)) : Math.max(0,Math.floor((st-now)/60000));
      $('#countdown').className = 'card banner ' + (live?'live':'next');
      $('#countdown').innerHTML = `<strong>${live?'Live now':'Next'}:</strong> ${sanitize(next.title)} ¬∑ ${fmtRange(st, en)} <span class="sub">(${live?'ends in':'starts in'} ${mins} min)</span>`;
    } else {
      $('#countdown').className = 'card banner'; $('#countdown').innerHTML = `<span class="sub">No upcoming sessions.</span>`;
    }

    const content = $('#today-content'); content.innerHTML='';
    if (!list.length){
      // No sessions: smiley + quip; no Day Summary in aside
      const prefs = Object.assign(defaultPrefs(), loadPrefs()||{});
      const card = document.createElement('div'); card.className='card'; card.style.gridColumn='span 12';
      const quips=[
        `No sessions today, ${prefs.name||'mate'}. Take a breather.`,
        `Calendar‚Äôs clear, ${prefs.name||'mate'}. Touch grass.`,
        `Zero on the docket. Get sunlight, ${prefs.name||'mate'}.`,
        `Free day. Read one page, lift something heavy.`
      ];
      const msg = quips[Math.floor(Math.random()*quips.length)];
      card.innerHTML = `<div class="hstack"><div class="smiley">üòä</div><div><div class="title">No sessions today</div><div class="sub">${sanitize(msg)}</div></div></div>`;
      content.append(card);
      const asideEl = $('#aside'); asideEl.innerHTML=''; asideEl.style.display='none';
      return;
    }

    renderEventList(content, list, now);

    // Right summary (only if list.length>0)
    const prefs = Object.assign(defaultPrefs(), loadPrefs()||{});
    const inPerson = list.filter(ev => !isRemote(ev));
    const first = list[0], last = list.reduce((m,e)=> toDate(e.end)>toDate(m.end)?e:m, list[0]);
    const arriveBy = inPerson.length? new Date(toDate(inPerson[0].start).getTime() - prefs.arriveBuf*60000) : null;
    const leaveAfter = inPerson.length? new Date(toDate(inPerson[inPerson.length-1].end).getTime() + prefs.leaveBuf*60000) : null;

    const aside = $('#aside'); aside.style.display=''; aside.innerHTML='';
    const sum = document.createElement('div'); sum.className='card';
    sum.innerHTML = `
      <div class="title">${prefs.name?sanitize(prefs.name)+', ':''}Today</div>
      <div class="sub">${list.length} sessions${inPerson.length?` ¬∑ ${inPerson.length} in‚Äëperson`:''}</div>
      <div class="grid" style="margin-top:6px">
        <div class=\"card\" style=\"grid-column:span 12\"><div class=\"sub\">First session</div><div class=\"title\">${fmtRange(first.start, first.end)}</div><div class=\"sub\">${sanitize(first.title)}</div></div>
        <div class=\"card\" style=\"grid-column:span 12\"><div class=\"sub\">Last session</div><div class=\"title\">${fmtRange(last.start, last.end)}</div><div class=\"sub\">${sanitize(last.title)}</div></div>
        <div class="card" style="grid-column:span 12"><div class="sub">Arrive by</div><div class="title">${arriveBy?fmtHM(arriveBy):'‚Äî'}</div></div>
        <div class="card" style="grid-column:span 12"><div class="sub">Leave after</div><div class="title">${leaveAfter?fmtHM(leaveAfter):'‚Äî'}</div></div>
      </div>
      <div class="hstack" style="margin-top:8px">
        <a class="btn" href="${mapsTransitLink(prefs.home, prefs.campusStation, {type:'arrive', time:arriveBy})}" target="_blank" rel="noopener" title="${arriveBy?'Arrive by '+fmtHM(arriveBy):'Open maps'}">Arrival trains</a>
        <a class="btn" href="${mapsTransitLink(prefs.campusStation, prefs.home, {type:'depart', time:leaveAfter})}" target="_blank" rel="noopener" title="${leaveAfter?'Depart after '+fmtHM(leaveAfter):'Open maps'}">Return trains</a>
      </div>
    `;
    aside.append(sum);
  }

  function renderWeek(){
    const base = new Date();
    // compute Monday start of week + offset
    const d=new Date(base.getFullYear(), base.getMonth(), base.getDate());
    d.setDate(d.getDate() + weekOffset*7);
    const dow=d.getDay(); const mon=new Date(d); mon.setDate(d.getDate() + (dow===0?-6:1-dow));
    const days=[]; for(let i=0;i<7;i++){ const x=new Date(mon); x.setDate(mon.getDate()+i); days.push(x); }

    $('#week-label').textContent = `Week of ${days[0].toLocaleDateString([], {month:'short', day:'numeric'})}`;
    const grid = $('#week-grid'); grid.innerHTML = ''; grid.style.gridTemplateColumns='repeat(7, minmax(0,1fr))';
    const evs = filteredEvents();
    days.forEach(day => {
      const col=document.createElement('div'); col.className='card';
      col.innerHTML = `<div class="sub" style="font-weight:800">${day.toLocaleDateString([], {weekday:'short', month:'short', day:'numeric'})}</div>`;
      const dayEvs = evs.filter(e => e.date === todayKey(day)).sort(byStart);
      if (!dayEvs.length){ const em=document.createElement('div'); em.className='sub'; em.textContent='‚Äî'; col.append(em); }
      else {
        dayEvs.forEach(ev => {
          const row=document.createElement('div'); row.className='event'+(compact?' compact':'');
          const bar=document.createElement('div'); bar.className='bar'; bar.style.background=colorFor(ev);
          const title=document.createElement('div'); title.innerHTML=`<div style="font-weight:800">${fmtRange(ev.start, ev.end)}</div><div class="sub">${sanitize(ev.title)}</div>${ev.staff?`<div class="sub">${sanitize(ev.staff)}</div>`:''}`;
          row.append(bar,title); col.append(row);
        });
      }
      grid.append(col);
    });
  }

  function renderAll(){
    const now = new Date();
    const av = $('#all'); av.innerHTML = '';
    const grouped = new Map();
    filteredEvents().forEach(ev => { if(!grouped.has(ev.date)) grouped.set(ev.date, []); grouped.get(ev.date).push(ev); });
    const dates = Array.from(grouped.keys()).sort();
    dates.forEach(k => {
      const head=document.createElement('div'); head.className='date-header'; head.id='date-'+k; head.textContent = new Date(k+'T00:00').toLocaleDateString([], {weekday:'short', month:'short', day:'numeric'});
      av.append(head);
      renderEventList(av, grouped.get(k).sort(byStart), now);
    });
    // Smart scroll to today or next
    const today = todayKey(new Date());
    const el = document.getElementById('date-'+today) || document.getElementById('date-'+(dates.find(d=>d>=today)||dates[dates.length-1]));
    if (el) el.scrollIntoView({behavior:'smooth', block:'start'});
  }

  async function renderShell(){
    $('#nowstr').textContent = new Date().toLocaleString();
    try {
      const w = await fetchWeather(); const cw=w.current_weather, d0=w.daily;
      $('#weather-emoji').textContent = wmoIcon(cw.weathercode);
      $('#weather-temp').textContent = Math.round(cw.temperature)+'¬∞C';
      $('#weather-hilo').textContent = 'H '+Math.round(d0.temperature_2m_max[0])+'¬∞ / L '+Math.round(d0.temperature_2m_min[0])+'¬∞';
      $('#weather-rain').textContent = d0.precipitation_probability_max[0];
    } catch { $('#weather-temp').textContent = 'weather unavailable'; }
  }

  function populateDomainFilter(data){
    const doms = Array.from(new Set(data.map(e => String(e.domain||'').trim()).filter(Boolean))).sort();
    const sel = document.getElementById('sel-domain');
    sel.innerHTML = '<option value="ALL">ALL</option>' + doms.map(d=>`<option>${d}</option>`).join('');
    sel.value = DOMAIN || 'ALL';
  }

  async function parseCSV(text){
    const lines = text.split(/\\r?\\n/).filter(Boolean);
    if (!lines.length) return [];
    const headers = lines[0].split(',').map(s=>s.trim());
    const idx = Object.fromEntries(headers.map((h,i)=>[h,i]));
    const out=[];
    for (let i=1;i<lines.length;i++){
      const row = lines[i].split(',');
      const g = String(row[idx['groups']]||'').split(';').map(s=>s.trim()).filter(Boolean);
      out.push({
        date: row[idx['date']], start: row[idx['start']], end: row[idx['end']], title: row[idx['title']],
        domain: row[idx['domain']], activity: row[idx['activity']], campus: row[idx['campus']],
        groups: g.length?g:['ALL'], venue: row[idx['venue']], staff: row[idx['staff']]
      });
    }
    return out;
  }

  async function tryAutoLoad(){
    if (location.protocol==='file:'){ return; }
    try {
      const r = await fetch('timetable.json', {cache:'no-cache'});
      if (r.ok){ EVENTS = await r.json(); localStorage.setItem('medi2101b_data', JSON.stringify(EVENTS)); populateDomainFilter(EVENTS); renderAll(); renderWeek(); renderToday(); return; }
    }catch{}
    try {
      const r = await fetch('timetable.csv', {cache:'no-cache'});
      if (r.ok){ const txt=await r.text(); EVENTS = await parseCSV(txt); localStorage.setItem('medi2101b_data', JSON.stringify(EVENTS)); populateDomainFilter(EVENTS); renderAll(); renderWeek(); renderToday(); return; }
    }catch{}
  }

  function toICS(list){
    function esc(s){ return String(s||'').replace(/([,;])/g,'\\\\$1').replace(/\\n/g,'\\\\n'); }
    function dt(v){ const d=toDate(v); return `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}T${pad(d.getHours())}${pad(d.getMinutes())}00`; }
    const lines=['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//MEDI2101B//Timetable//EN'];
    list.forEach((e,i)=>{ lines.push('BEGIN:VEVENT','UID:'+(e.start+'_'+i+'@medi2101b'),'DTSTART:'+dt(e.start),'DTEND:'+dt(e.end),'SUMMARY:'+esc(e.title)); const desc=[e.domain,e.activity,e.campus,e.venue,e.staff].filter(Boolean).join(' ¬∑ '); if(desc) lines.push('DESCRIPTION:'+esc(desc)); lines.push('END:VEVENT'); });
    lines.push('END:VCALENDAR'); return lines.join('\\r\\n');
  }


  // --- Toast helper ---
  function showToast(msg){
    const t = document.getElementById('toast');
    t.textContent = String(msg);
    t.style.display = 'block';
    requestAnimationFrame(()=>{
      t.classList.add('show');
      setTimeout(()=>{ t.classList.remove('show'); setTimeout(()=>{ t.style.display='none'; }, 200); }, 1600);
    });
  }

  // --- Notifications ---
  let notifiedKeys = new Set();
  function notifyToggle(){
    const btn = document.getElementById('btn-bell');
    btn.classList.add('pulse');
    setTimeout(()=>btn.classList.remove('pulse'), 400);

    if (!('Notification' in window)){
      showToast('Notifications not supported');
      return;
    }
    if (Notification.permission === 'default'){
      Notification.requestPermission().then(p => {
        if (p === 'granted'){ localStorage.setItem('medi2101b_notify','on'); btn.textContent='üîî'; showToast('Notifications on'); }
        else { localStorage.setItem('medi2101b_notify','off'); btn.textContent='üîï'; showToast('Notifications blocked'); }
      });
      return;
    }
    const on = localStorage.getItem('medi2101b_notify') === 'on';
    if (Notification.permission !== 'granted'){
      localStorage.setItem('medi2101b_notify','off'); btn.textContent='üîï'; showToast('Notifications blocked');
      return;
    }
    localStorage.setItem('medi2101b_notify', on ? 'off' : 'on');
    btn.textContent = on ? 'üîï' : 'üîî';
    showToast(on ? 'Notifications off' : 'Notifications on');
  }

  function maybeNotify(){
    if (localStorage.getItem('medi2101b_notify')!=='on') return;
    if (!('Notification' in window) || Notification.permission!=='granted') return;
    const now = new Date();
    filteredEvents().forEach(e => {
      const s = toDate(e.start);
      const key = e.start+'|'+e.title;
      const mins = Math.floor((s-now)/60000);
      if (mins === 10 && !notifiedKeys.has(key)){
        notifiedKeys.add(key);
        try { new Notification('Starts in 10 minutes', { body: e.title + ' ¬∑ ' + fmtHM(s) }); } catch {}
      }
    });
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    // Theme
    setTheme(theme());

    // Sidebar controls (filters mirror settings)
    const p=Object.assign(defaultPrefs(), loadPrefs()||{});
    $('#sel-campus').value=p.campus; $('#sel-group').value=p.group;
    $('#sel-domain').value=DOMAIN;

    // Tabs
    $$('.tab').forEach(t=>t.addEventListener('click', ()=>{
      $$('.tab').forEach(x=>x.classList.remove('active')); t.classList.add('active');
      const tab=t.dataset.tab; $('#today').style.display = tab==='today'?'grid':'none'; $('#week').style.display = tab==='week'?'grid':'none'; $('#all').style.display = tab==='all'?'grid':'none';
      if (tab==='all') renderAll(); if (tab==='week') renderWeek(); if (tab==='today') renderToday();
    }));

    // Buttons
    const bellOn = localStorage.getItem('medi2101b_notify')==='on';
    $('#btn-bell').textContent = bellOn ? 'üîî' : 'üîï';
    $('#btn-bell').addEventListener('click', notifyToggle);
    $('#btn-theme').addEventListener('click', ()=>{ const t=theme()==='dark'?'light':'dark'; setTheme(t); renderShell(); });
    $('#btn-compact').addEventListener('click', ()=>{ compact=!compact; $('#btn-compact').textContent = compact?'Expanded':'Compact'; renderAll(); renderWeek(); renderToday(); });
    $('#btn-ics').addEventListener('click', ()=>{ const blob=new Blob([toICS(filteredEvents())], {type:'text/calendar'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='medi2101b_filtered.ics'; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href), 400); });
    $('#btn-load').addEventListener('click', ()=>$('#file-input').click());
    $('#file-input').addEventListener('change', async e=>{ const f=e.target.files?.[0]; if (!f) return; const text=await f.text(); if (f.name.endsWith('.json')) EVENTS=JSON.parse(text); else if (f.name.endsWith('.csv')) EVENTS=await parseCSV(text); else { alert('Use timetable.json or timetable.csv'); return; } localStorage.setItem('medi2101b_data', JSON.stringify(EVENTS)); populateDomainFilter(EVENTS); renderAll(); renderWeek(); renderToday(); });

    $('#btn-settings').addEventListener('click', ()=>{
      const q=Object.assign(defaultPrefs(), loadPrefs()||{});
      $('#set-campus').value=q.campus; $('#set-group').value=q.group; $('#set-label').value=q.label; $('#set-name').value=q.name||''; $('#set-home').value=q.home||''; $('#set-campus-st').value=q.campusStation||'Gosford Station'; $('#set-arrive').value=q.arriveBuf; $('#set-leave').value=q.leaveBuf; $('#set-timefmt').value=q.timeFmt||'24h';
      $('#modal-backdrop').style.display='flex'; $('#modal-backdrop').setAttribute('aria-hidden','false');
    });
    function closeModal(){ $('#modal-backdrop').style.display='none'; $('#modal-backdrop').setAttribute('aria-hidden','true'); }
    $('#btn-x').addEventListener('click', closeModal); $('#btn-close').addEventListener('click', closeModal);
    $('#btn-save').addEventListener('click', ()=>{ const q={ campus:$('#set-campus').value, group:$('#set-group').value, label:$('#set-label').value, name:$('#set-name').value, home:$('#set-home').value, campusStation:$('#set-campus-st').value, arriveBuf:parseInt($('#set-arrive').value||'15',10), leaveBuf:parseInt($('#set-leave').value||'10',10), timeFmt:$('#set-timefmt').value}; savePrefs(q); // mirror to sidebar
      $('#sel-campus').value=q.campus; $('#sel-group').value=q.group; closeModal(); renderAll(); renderWeek(); renderToday(); });

    // Filters
    $('#sel-campus').addEventListener('change', ()=>{ const q=Object.assign(defaultPrefs(), loadPrefs()||{}); q.campus=$('#sel-campus').value; savePrefs(q); renderAll(); renderWeek(); renderToday(); });
    $('#sel-group').addEventListener('change', ()=>{ const q=Object.assign(defaultPrefs(), loadPrefs()||{}); q.group=$('#sel-group').value; savePrefs(q); renderAll(); renderWeek(); renderToday(); });
    $('#sel-domain').addEventListener('change', (e)=>{ DOMAIN=e.target.value; renderAll(); renderWeek(); renderToday(); });

    // Week nav (robust)
    document.addEventListener('click', (e)=>{
      const id = e.target && e.target.id;
      if (id === 'btn-prev-week'){ weekOffset--; renderWeek(); }
      if (id === 'btn-next-week'){ weekOffset++; renderWeek(); }
    });

    // Initial data
    const cached = localStorage.getItem('medi2101b_data');
    if (cached){ try{ EVENTS=JSON.parse(cached); populateDomainFilter(EVENTS);}catch{} }

    renderShell();
    tryAutoLoad();
    renderToday(); // first paint
    setInterval(()=>{ renderShell(); maybeNotify(); }, 60*1000);
  });
</script>
</body>
</html>
